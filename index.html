
<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Directorio de Negocios</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script><!-- Firebase SDK -->
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // ğŸ”¥ CONFIGURACIÃ“N FIREBASE - REEMPLAZA CON TU CONFIGURACIÃ“N
        const firebaseConfig = {
            apiKey: "AIzaSyDemo-Replace-With-Your-Key",
            authDomain: "tu-proyecto.firebaseapp.com", 
            projectId: "tu-proyecto-id",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Inicializar Firebase
        let app, db;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            window.firebaseDB = db;
            window.firebaseModules = { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc };
            window.isFirebaseConnected = true;
            console.log('ğŸ”¥ Firebase conectado exitosamente');
        } catch (error) {
            console.log('âš ï¸ Firebase no disponible, usando modo local');
            window.isFirebaseConnected = false;
        }
    </script>
  <style>
        body {
            box-sizing: border-box;
        }
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #db3717;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .category-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .category-card:hover {
            transform: scale(1.05);
        }
        .business-card {
            transition: all 0.2s ease;
        }
        .business-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .orange-gradient {
            background: linear-gradient(135deg, #db3717 0%, #ff6b47 100%);
        }
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
        }
        .mobile-header {
            position: sticky;
            top: 0;
            z-index: 40;
        }
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        .swipe-indicator {
            width: 40px;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            margin: 8px auto;
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .toast.show {
            opacity: 1;
        }
        .toast.success {
            background-color: #10b981;
        }
        .toast.error {
            background-color: #ef4444;
        }
        .toast.info {
            background-color: #3b82f6;
        }
        .firebase-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .firebase-connected {
            background-color: #10b981;
            color: white;
        }
        .firebase-local {
            background-color: #f59e0b;
            color: white;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gray-50 min-h-full"><!-- Indicador de Estado Firebase -->
  <div id="firebase-status" class="firebase-status firebase-local">
   ğŸ”„ Conectando...
  </div><!-- Header MÃ³vil -->
  <div class="mobile-header bg-white shadow-lg safe-area-top"><!-- Franja Naranja Superior -->
   <div class="orange-gradient h-2 w-full"></div><!-- Logo y TÃ­tulo -->
   <div class="px-4 py-3">
    <div class="flex items-center justify-between">
     <div class="flex items-center space-x-2">
      <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-lg font-bold" style="background-color: #db3717;">
       ğŸ¢
      </div>
      <div>
       <h1 id="company-name" class="text-lg font-bold" style="color: #151a2b;">Mi Empresa</h1>
       <p id="city-subtitle" class="text-xs text-gray-600">Mi Ciudad</p>
      </div>
     </div><button id="menu-btn" class="touch-target flex items-center justify-center rounded-lg" style="background-color: #151a2b;"> <span class="text-white text-lg">â˜°</span> </button>
    </div>
   </div><!-- Barra de BÃºsqueda -->
   <div class="px-4 pb-3">
    <div class="relative"><input type="text" id="search-input" placeholder="ğŸ” Buscar negocios..." class="w-full px-4 py-3 pr-12 border-2 rounded-xl focus:outline-none focus:ring-2 text-sm" style="border-color: #db3717; --tw-ring-color: #db3717;"> <button id="search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white px-3 py-1 rounded-lg" style="background-color: #db3717;"> ğŸ” </button>
    </div>
   </div>
  </div><!-- MenÃº Lateral MÃ³vil -->
  <div id="mobile-menu" class="fixed inset-0 z-50 hidden">
   <div class="modal-backdrop absolute inset-0" onclick="closeMobileMenu()"></div>
   <div class="absolute right-0 top-0 h-full w-80 bg-white shadow-xl transform translate-x-full transition-transform duration-300" id="menu-panel">
    <div class="safe-area-top"><!-- Header del MenÃº -->
     <div class="orange-gradient p-4 text-white">
      <div class="flex items-center justify-between">
       <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full bg-white bg-opacity-20 flex items-center justify-center text-xl">
         ğŸ¢
        </div>
        <div>
         <h2 class="font-bold">MenÃº Principal</h2>
         <p class="text-sm opacity-90">Directorio de Negocios</p>
        </div>
       </div><button onclick="closeMobileMenu()" class="touch-target flex items-center justify-center"> <span class="text-white text-xl">âœ•</span> </button>
      </div>
     </div><!-- Opciones del MenÃº -->
     <div class="p-4 space-y-2"><button id="about-btn-mobile" class="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-50 transition-colors"> <span class="text-2xl">ğŸ‘¥</span> <span class="font-medium" id="about-text">QuiÃ©nes Somos</span> </button> <button id="services-btn-mobile" class="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-50 transition-colors"> <span class="text-2xl">ğŸ› ï¸</span> <span class="font-medium" id="services-text">Servicios que Prestamos</span> </button> <button id="contract-service-btn-mobile" class="w-full flex items-center space-x-3 p-3 rounded-xl text-white transition-colors" style="background-color: #db3717;"> <span class="text-2xl">ğŸ’¬</span> <span class="font-medium">Contratar Servicio</span> </button>
      <div class="border-t border-gray-200 my-4"></div><button id="admin-btn-mobile" class="w-full flex items-center space-x-3 p-3 rounded-xl text-white transition-colors" style="background-color: #151a2b;"> <span class="text-2xl">ğŸ”</span> <span class="font-medium">Administrador</span> </button>
     </div>
    </div>
   </div>
  </div>
  <div class="px-4 py-4"><!-- CategorÃ­as -->
   <div class="mb-6">
    <h2 class="text-xl font-bold mb-4" style="color: #151a2b;">CategorÃ­as</h2>
    <div class="grid grid-cols-3 gap-3" id="categories-grid"><!-- CategorÃ­as se generarÃ¡n dinÃ¡micamente -->
    </div>
   </div><!-- Filtros Activos -->
   <div id="active-filters" class="mb-4 hidden">
    <div class="flex flex-wrap items-center gap-2"><span class="text-xs font-medium text-gray-600">Filtros:</span>
     <div id="filter-tags" class="flex flex-wrap gap-1"></div><button id="clear-filters" class="text-xs px-3 py-1 rounded-full border hover:bg-gray-50" style="border-color: #db3717; color: #db3717;"> âœ• Limpiar </button>
    </div>
   </div><!-- Contador de Negocios -->
   <div class="mb-4">
    <p id="business-count" class="text-lg font-medium" style="color: #151a2b;">Cargando negocios...</p>
   </div><!-- Grid de Negocios -->
   <div id="business-grid" class="space-y-4"><!-- Los negocios se mostrarÃ¡n aquÃ­ -->
   </div><!-- Estado VacÃ­o -->
   <div id="empty-state" class="text-center py-12 hidden">
    <div class="text-5xl mb-4">
     ğŸª
    </div>
    <h3 class="text-xl font-bold mb-3" style="color: #151a2b;">Â¡SÃ© el primero!</h3>
    <p class="text-gray-600 mb-6 text-sm">No hay negocios publicados aÃºn. Publica el tuyo y comienza a crecer.</p><button id="empty-add-btn" class="px-6 py-3 rounded-xl font-medium text-white transition-all" style="background-color: #db3717;"> â• Publicar Primer Negocio </button>
   </div><!-- Sin Resultados -->
   <div id="no-results-state" class="text-center py-12 hidden">
    <div class="text-5xl mb-4">
     ğŸ”
    </div>
    <h3 class="text-xl font-bold mb-3" style="color: #151a2b;">Sin resultados</h3>
    <p class="text-gray-600 text-sm">No encontramos negocios que coincidan con tu bÃºsqueda.</p>
   </div>
  </div><!-- Pie de PÃ¡gina -->
  <footer class="mt-8" style="background-color: #151a2b;">
   <div class="px-4 py-6 text-center">
    <div class="flex items-center justify-between">
     <p class="text-white text-sm font-medium">Hecho por SOLUM</p><button id="scroll-to-top" class="w-10 h-10 rounded-lg flex items-center justify-center text-white transition-all hover:bg-white hover:bg-opacity-20" style="background-color: rgba(255,255,255,0.1);"> <span class="text-lg">â†‘</span> </button>
    </div>
   </div>
  </footer><!-- Modal Publicar Negocio -->
  <div id="add-modal" class="fixed inset-0 modal-backdrop hidden items-end justify-center z-50">
   <div class="bg-white rounded-t-3xl shadow-xl w-full max-h-[90vh] overflow-y-auto">
    <div class="swipe-indicator"></div>
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold" style="color: #151a2b;">ğŸ“ Publicar Negocio</h2><button id="close-modal" class="touch-target flex items-center justify-center text-gray-500"> <span class="text-2xl">âœ•</span> </button>
     </div>
     <form id="business-form">
      <div class="space-y-4">
       <div><label for="business-name" class="block text-sm font-medium mb-2" style="color: #151a2b;">Nombre del Negocio *</label> <input type="text" id="business-name" required class="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:ring-2" style="border-color: #db3717; --tw-ring-color: #db3717;" placeholder="Ej: Restaurante El Buen Sabor">
       </div>
       <div><label for="business-category" class="block text-sm font-medium mb-2" style="color: #151a2b;">CategorÃ­a *</label> <select id="business-category" required class="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:ring-2" style="border-color: #db3717; --tw-ring-color: #db3717;"> <option value="">Seleccionar categorÃ­a</option> </select>
       </div>
       <div><label for="business-description" class="block text-sm font-medium mb-2" style="color: #151a2b;">DescripciÃ³n</label> <textarea id="business-description" rows="4" class="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:ring-2" style="border-color: #db3717; --tw-ring-color: #db3717;" placeholder="Describe tu negocio..."></textarea>
       </div>
       <div><label for="business-logo" class="block text-sm font-medium mb-2" style="color: #151a2b;">Logo de la Empresa</label> <input type="url" id="business-logo" class="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:ring-2" style="border-color: #db3717; --tw-ring-color: #db3717;" placeholder="https://ejemplo.com/mi-logo.jpg">
        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Pega aquÃ­ la URL de tu logo (debe ser una imagen pÃºblica en internet)</p>
       </div>
       <div><label for="business-website" class="block text-sm font-medium mb-2" style="color: #151a2b;">Sitio Web</label> <input type="url" id="business-website" class="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:ring-2" style="border-color: #db3717; --tw-ring-color: #db3717;" placeholder="https://www.minegocio.com">
       </div>
       <div><label class="block text-sm font-medium mb-2" style="color: #151a2b;">GalerÃ­a de ImÃ¡genes</label>
        <div id="gallery-inputs" class="space-y-2">
         <div class="flex items-center space-x-2"><input type="url" class="gallery-url flex-1 px-4 py-3 border-2 rounded-xl focus:outline-none focus:ring-2" style="border-color: #db3717; --tw-ring-color: #db3717;" placeholder="https://ejemplo.com/imagen1.jpg"> <button type="button" onclick="removeGalleryInput(this)" class="px-3 py-3 rounded-xl text-white" style="background-color: #ef4444;"> ğŸ—‘ï¸ </button>
         </div>
        </div><button type="button" id="add-gallery-btn" class="mt-2 w-full py-2 px-4 border-2 border-dashed rounded-xl hover:bg-gray-50 transition-colors" style="border-color: #db3717; color: #db3717;"> â• Agregar Imagen </button>
        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Agrega URLs de imÃ¡genes pÃºblicas para mostrar en la galerÃ­a del perfil</p>
       </div>
      </div>
      <div class="flex gap-4 mt-8"><button type="button" id="cancel-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 px-4 rounded-xl font-medium transition-colors"> Cancelar </button> <button type="submit" id="submit-btn" class="flex-1 text-white py-3 px-4 rounded-xl font-medium transition-colors" style="background-color: #db3717;"> Publicar Negocio </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Modal InformaciÃ³n -->
  <div id="info-modal" class="fixed inset-0 modal-backdrop hidden items-end justify-center z-50">
   <div class="bg-white rounded-t-3xl shadow-xl w-full max-h-[80vh] overflow-y-auto">
    <div class="swipe-indicator"></div>
    <div class="p-6">
     <div class="flex justify-between items-center mb-4">
      <h2 id="info-modal-title" class="text-xl font-bold" style="color: #151a2b;"></h2><button id="close-info-modal" class="touch-target flex items-center justify-center text-gray-500"> <span class="text-2xl">âœ•</span> </button>
     </div>
     <div id="info-modal-content" class="text-gray-600"><!-- Contenido dinÃ¡mico -->
     </div>
    </div>
   </div>
  </div><!-- PÃ¡gina de Perfil del Negocio -->
  <div id="business-profile-page" class="fixed inset-0 bg-gray-50 hidden z-50 overflow-y-auto"><!-- Header del Perfil -->
   <div class="mobile-header bg-white shadow-lg safe-area-top">
    <div class="orange-gradient h-2 w-full"></div>
    <div class="px-4 py-3">
     <div class="flex items-center justify-between"><button id="back-to-directory" class="touch-target flex items-center justify-center rounded-lg" style="background-color: #151a2b;"> <span class="text-white text-lg">â†</span> </button>
      <div class="text-center">
       <h1 class="text-lg font-bold" style="color: #151a2b;">Perfil del Negocio</h1>
      </div>
      <div class="w-10"></div><!-- Spacer -->
     </div>
    </div>
   </div><!-- Contenido del Perfil -->
   <div class="px-4 py-4"><!-- InformaciÃ³n Principal -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
     <div class="text-center mb-6">
      <div id="profile-logo-container" class="w-24 h-24 bg-gray-100 border-2 border-dashed border-gray-300 rounded-2xl flex items-center justify-center mb-4 text-gray-400 text-xs text-center mx-auto overflow-hidden">
       ğŸ“·<br>
       Logo<br>
       Empresa
      </div>
      <h1 id="profile-business-name" class="text-2xl font-bold mb-2" style="color: #151a2b;"></h1>
      <div id="profile-business-category" class="inline-block px-4 py-2 rounded-full text-white font-medium" style="background-color: #db3717;"></div>
     </div>
     <div id="profile-description" class="text-gray-700 text-center"></div>
    </div><!-- Botones de Contacto -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
     <h2 class="text-lg font-bold mb-4 text-center" style="color: #151a2b;">Conecta con Nosotros</h2>
     <div class="grid grid-cols-2 gap-3"><button id="whatsapp-btn" class="flex flex-col items-center p-4 rounded-xl transition-all" style="background-color: #25D366; color: white;">
       <svg class="w-6 h-6 mb-1" fill="currentColor" viewbox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488" />
       </svg><span class="font-medium text-sm">WhatsApp</span> </button> <button id="phone-btn" class="flex flex-col items-center p-4 rounded-xl transition-all" style="background-color: #db3717; color: white;"> <span class="text-2xl mb-1">ğŸ“</span> <span class="font-medium text-sm">Llamar</span> </button> <button id="instagram-btn" class="flex flex-col items-center p-4 rounded-xl transition-all" style="background-color: #E4405F; color: white;">
       <svg class="w-6 h-6 mb-1" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
       </svg><span class="font-medium text-sm">Instagram</span> </button> <button id="location-btn" class="flex flex-col items-center p-4 rounded-xl transition-all" style="background-color: #151a2b; color: white;">
       <svg class="w-6 h-6 mb-1" fill="currentColor" viewbox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
       </svg><span class="font-medium text-sm">UbicaciÃ³n</span> </button>
     </div>
    </div><!-- GalerÃ­a de ImÃ¡genes -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
     <h2 class="text-lg font-bold mb-4 text-center" style="color: #151a2b;">GalerÃ­a de ImÃ¡genes</h2>
     <div class="relative">
      <div id="image-gallery" class="w-full h-48 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden">
       <div id="gallery-slide" class="w-full h-full flex items-center justify-center text-gray-400 text-4xl transition-all duration-1000">
        ğŸ–¼ï¸
       </div>
      </div>
      <div class="flex justify-center mt-3 space-x-2" id="gallery-dots"><!-- Dots se generarÃ¡n dinÃ¡micamente -->
      </div>
     </div>
    </div>
   </div>
  </div><!-- Modal de Login Administrador -->
  <div id="admin-login-modal" class="fixed inset-0 modal-backdrop hidden items-end justify-center z-50">
   <div class="bg-white rounded-t-3xl shadow-xl w-full max-h-[80vh] overflow-y-auto">
    <div class="swipe-indicator"></div>
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold" style="color: #151a2b;">ğŸ” Acceso Administrador</h2><button id="close-admin-login" class="touch-target flex items-center justify-center text-gray-500"> <span class="text-2xl">âœ•</span> </button>
     </div>
     <form id="admin-login-form">
      <div class="mb-6"><label for="admin-password" class="block text-sm font-medium mb-2" style="color: #151a2b;">ContraseÃ±a de Administrador</label> <input type="password" id="admin-password" required class="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:ring-2" style="border-color: #db3717; --tw-ring-color: #db3717;" placeholder="Ingrese la contraseÃ±a">
      </div>
      <div class="flex gap-3"><button type="button" id="cancel-admin-login" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 px-4 rounded-xl font-medium transition-colors"> Cancelar </button> <button type="submit" class="flex-1 text-white py-3 px-4 rounded-xl font-medium transition-colors" style="background-color: #db3717;"> Ingresar </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- PÃ¡gina de Administrador -->
  <div id="admin-page" class="fixed inset-0 bg-gray-50 hidden z-50 overflow-y-auto"><!-- Header Admin -->
   <div class="mobile-header bg-white shadow-lg safe-area-top">
    <div class="orange-gradient h-2 w-full"></div>
    <div class="px-4 py-3">
     <div class="flex items-center justify-between"><button id="back-to-main" class="touch-target flex items-center justify-center rounded-lg" style="background-color: #151a2b;"> <span class="text-white text-lg">â†</span> </button>
      <div class="text-center">
       <h1 class="text-lg font-bold" style="color: #151a2b;">Panel Admin</h1>
      </div><button id="logout-admin" class="touch-target flex items-center justify-center rounded-lg" style="background-color: #db3717;"> <span class="text-white text-lg">ğŸšª</span> </button>
     </div>
    </div>
   </div><!-- Contenido Admin -->
   <div class="px-4 py-4"><!-- EstadÃ­sticas -->
    <div class="grid grid-cols-3 gap-3 mb-6">
     <div class="bg-white rounded-2xl p-4 text-center shadow-lg">
      <div class="text-2xl font-bold mb-1" style="color: #db3717;" id="total-businesses">
       0
      </div>
      <div class="text-xs text-gray-600">
       Negocios
      </div>
     </div>
     <div class="bg-white rounded-2xl p-4 text-center shadow-lg">
      <div class="text-2xl font-bold mb-1" style="color: #151a2b;" id="total-categories">
       14
      </div>
      <div class="text-xs text-gray-600">
       CategorÃ­as
      </div>
     </div>
     <div class="bg-white rounded-2xl p-4 text-center shadow-lg">
      <div class="text-2xl font-bold mb-1" style="color: #db3717;" id="recent-businesses">
       0
      </div>
      <div class="text-xs text-gray-600">
       Recientes
      </div>
     </div>
    </div><!-- GestiÃ³n de Negocios -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
     <h2 class="text-lg font-bold mb-4" style="color: #151a2b;">ğŸ“‹ GestiÃ³n de Negocios</h2>
     <div class="space-y-3"><button id="admin-add-business" class="w-full p-4 rounded-xl border-2 border-dashed hover:bg-gray-50 transition-colors" style="border-color: #db3717; color: #db3717;">
       <div class="text-2xl mb-1">
        â•
       </div>
       <div class="font-medium">
        Publicar Negocio
       </div></button> <button id="manage-businesses" class="w-full p-4 rounded-xl border-2 border-dashed hover:bg-gray-50 transition-colors" style="border-color: #151a2b; color: #151a2b;">
       <div class="text-2xl mb-1">
        ğŸ“Š
       </div>
       <div class="font-medium">
        Gestionar Negocios
       </div></button>
     </div>
    </div><!-- GestiÃ³n de CategorÃ­as -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-4">
     <h2 class="text-lg font-bold mb-4" style="color: #151a2b;">ğŸ·ï¸ GestiÃ³n de CategorÃ­as</h2><button id="manage-categories" class="w-full p-4 rounded-xl border-2 border-dashed hover:bg-gray-50 transition-colors" style="border-color: #db3717; color: #db3717;">
      <div class="text-2xl mb-1">
       ğŸ·ï¸
      </div>
      <div class="font-medium">
       Modificar CategorÃ­as
      </div></button>
    </div>
   </div>
  </div>
  <script>
        // ğŸ”¥ CONFIGURACIÃ“N FIREBASE - INSTRUCCIONES PARA CONFIGURAR
        /*
        PASOS PARA CONFIGURAR FIREBASE:
        
        1. Ve a https://console.firebase.google.com/
        2. Crea un nuevo proyecto o usa uno existente
        3. Ve a "Project Settings" > "General" > "Your apps"
        4. Haz clic en "Add app" y selecciona "Web"
        5. Registra tu app y copia la configuraciÃ³n
        6. Reemplaza la configuraciÃ³n de abajo con la tuya
        7. Ve a "Firestore Database" y crea una base de datos
        8. Configura las reglas de seguridad (ver abajo)
        
        REGLAS DE FIRESTORE (copia esto en Rules):
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /businesses/{document} {
              allow read, write: if true;
            }
          }
        }
        */

        // ConfiguraciÃ³n
        const defaultConfig = {
            company_name: "Mi Empresa",
            city_name: "Mi Ciudad",
            about_text: "QuiÃ©nes Somos",
            services_text: "Servicios que Prestamos"
        };

        // CategorÃ­as de negocios
        let categories = [
            { name: "Hoteles", icon: "ğŸ¨", color: "#db3717" },
            { name: "Restaurantes", icon: "ğŸ½ï¸", color: "#151a2b" },
            { name: "HeladerÃ­as", icon: "ğŸ¦", color: "#db3717" },
            { name: "Tiendas", icon: "ğŸ›ï¸", color: "#151a2b" },
            { name: "Servicios", icon: "ğŸ”§", color: "#db3717" },
            { name: "Salud", icon: "ğŸ¥", color: "#151a2b" },
            { name: "EducaciÃ³n", icon: "ğŸ“š", color: "#db3717" },
            { name: "Entretenimiento", icon: "ğŸ­", color: "#151a2b" },
            { name: "Transporte", icon: "ğŸš—", color: "#db3717" },
            { name: "Belleza", icon: "ğŸ’„", color: "#151a2b" },
            { name: "Deportes", icon: "âš½", color: "#db3717" },
            { name: "TecnologÃ­a", icon: "ğŸ’»", color: "#151a2b" },
            { name: "HolÃ­stico", icon: "ğŸ§˜", color: "#db3717" },
            { name: "Ropa y Calzado", icon: "ğŸ‘•", color: "#151a2b" }
        ];

        // Variables globales
        let allBusinesses = [];
        let filteredBusinesses = [];
        let activeFilters = {
            search: '',
            category: ''
        };
        let currentBusiness = null;
        let galleryInterval = null;
        let currentSlide = 0;
        let isAdminLoggedIn = false;
        let isDataSdkConnected = false;
        let firebaseUnsubscribe = null;

        // Data Handler para el SDK de Canva (fallback)
        const dataHandler = {
            onDataChanged(data) {
                if (!window.isFirebaseConnected) {
                    allBusinesses = data || [];
                    applyFilters();
                    updateBusinessCount();
                    updateAdminStats();
                }
            }
        };

        // ğŸ”¥ FUNCIONES FIREBASE
        async function initializeFirebase() {
            // Esperar a que Firebase estÃ© disponible
            let attempts = 0;
            while (!window.firebaseDB && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (window.isFirebaseConnected && window.firebaseDB) {
                try {
                    const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
                    
                    // Escuchar cambios en tiempo real
                    const businessesRef = collection(window.firebaseDB, 'businesses');
                    const q = query(businessesRef, orderBy('fechaCreacion', 'desc'));
                    
                    firebaseUnsubscribe = onSnapshot(q, (snapshot) => {
                        allBusinesses = [];
                        snapshot.forEach((doc) => {
                            allBusinesses.push({ id: doc.id, ...doc.data() });
                        });
                        
                        applyFilters();
                        updateBusinessCount();
                        updateAdminStats();
                        updateFirebaseStatus(true);
                    }, (error) => {
                        console.error('Error escuchando cambios:', error);
                        loadBusinessesFromStorage();
                        updateFirebaseStatus(false);
                    });
                    
                    console.log('ğŸ”¥ Firebase conectado y escuchando cambios');
                    return true;
                } catch (error) {
                    console.error('Error configurando Firebase:', error);
                    loadBusinessesFromStorage();
                    updateFirebaseStatus(false);
                    return false;
                }
            } else {
                console.log('âš ï¸ Firebase no disponible, usando almacenamiento local');
                loadBusinessesFromStorage();
                updateFirebaseStatus(false);
                return false;
            }
        }

        async function saveBusinessToFirebase(businessData) {
            if (!window.isFirebaseConnected) {
                throw new Error('Firebase no disponible');
            }

            const { collection, addDoc } = window.firebaseModules;
            const businessesRef = collection(window.firebaseDB, 'businesses');
            
            // Remover el ID local antes de guardar en Firebase
            const { id, ...dataToSave } = businessData;
            
            const docRef = await addDoc(businessesRef, dataToSave);
            return docRef.id;
        }

        function updateFirebaseStatus(connected) {
            const statusElement = document.getElementById('firebase-status');
            if (connected) {
                statusElement.textContent = 'ğŸ”¥ Firebase Conectado';
                statusElement.className = 'firebase-status firebase-connected';
            } else {
                statusElement.textContent = 'ğŸ’¾ Modo Local';
                statusElement.className = 'firebase-status firebase-local';
            }
            
            // Ocultar despuÃ©s de 3 segundos
            setTimeout(() => {
                statusElement.style.opacity = '0.7';
            }, 3000);
        }

        // InicializaciÃ³n
        async function initializeApp() {
            // Inicializar Element SDK si estÃ¡ disponible
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    render: async (config) => {
                        document.getElementById('company-name').textContent = config.company_name || defaultConfig.company_name;
                        document.getElementById('city-subtitle').textContent = config.city_name || defaultConfig.city_name;
                        document.getElementById('about-text').textContent = config.about_text || defaultConfig.about_text;
                        document.getElementById('services-text').textContent = config.services_text || defaultConfig.services_text;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["company_name", config.company_name || defaultConfig.company_name],
                        ["city_name", config.city_name || defaultConfig.city_name],
                        ["about_text", config.about_text || defaultConfig.about_text],
                        ["services_text", config.services_text || defaultConfig.services_text]
                    ])
                });
            }

            // Inicializar Firebase primero
            const firebaseConnected = await initializeFirebase();
            
            // Si Firebase no estÃ¡ disponible, intentar Data SDK de Canva
            if (!firebaseConnected && window.dataSdk) {
                try {
                    const result = await window.dataSdk.init(dataHandler);
                    if (result.isOk) {
                        isDataSdkConnected = true;
                        updateFirebaseStatus(false);
                        showToast('ğŸ“Š Usando Canva Sheet para datos', 'info');
                    }
                } catch (error) {
                    console.error('Error con Data SDK:', error);
                    loadBusinessesFromStorage();
                    updateFirebaseStatus(false);
                }
            }

            renderCategories();
            populateCategorySelect();
            setupEventListeners();
        }

        // Funciones de almacenamiento local (fallback)
        function saveBusinessesToStorage() {
            localStorage.setItem('directoryBusinesses', JSON.stringify(allBusinesses));
        }

        function loadBusinessesFromStorage() {
            const stored = localStorage.getItem('directoryBusinesses');
            if (stored) {
                allBusinesses = JSON.parse(stored);
                applyFilters();
                updateBusinessCount();
            } else {
                allBusinesses = [];
                applyFilters();
                updateBusinessCount();
            }
        }

        // Renderizar categorÃ­as
        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = categories.map((category, index) => `
                <div class="category-card bg-white rounded-2xl p-4 text-center shadow-md border-2 border-transparent hover:border-current" 
                     style="color: ${category.color};" 
                     onclick="filterByCategory('${category.name}')">
                    <div class="text-3xl mb-2">${category.icon}</div>
                    <h3 class="font-semibold text-sm">${category.name}</h3>
                </div>
            `).join('');
        }

        // Poblar select de categorÃ­as
        function populateCategorySelect() {
            const select = document.getElementById('business-category');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar categorÃ­a</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = `${category.icon} ${category.name}`;
                    select.appendChild(option);
                });
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // MenÃº mÃ³vil
            document.getElementById('menu-btn').addEventListener('click', openMobileMenu);

            // BotÃ³n scroll to top
            document.getElementById('scroll-to-top').addEventListener('click', scrollToTop);

            // BÃºsqueda
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.getElementById('search-btn').addEventListener('click', handleSearch);

            // Botones de menÃº mÃ³vil
            document.getElementById('about-btn-mobile').addEventListener('click', () => {
                closeMobileMenu();
                showInfoModal('QuiÃ©nes Somos', 'Somos una empresa dedicada a conectar negocios locales con la comunidad. Nuestro objetivo es promover el comercio local y facilitar que las personas descubran los mejores servicios de su ciudad.');
            });
            document.getElementById('services-btn-mobile').addEventListener('click', () => {
                closeMobileMenu();
                showInfoModal('Nuestros Servicios', 'Ofrecemos una plataforma completa para que los negocios locales puedan: â€¢ Publicar su informaciÃ³n de contacto â€¢ Mostrar sus servicios y productos â€¢ Conectar con clientes potenciales â€¢ Aumentar su visibilidad en la comunidad');
            });

            // BotÃ³n contratar servicio
            document.getElementById('contract-service-btn-mobile').addEventListener('click', () => {
                closeMobileMenu();
                const message = encodeURIComponent('Hola! Me interesa contratar sus servicios para publicar mi negocio en el directorio.');
                window.open(`https://wa.me/19752224?text=${message}`, '_blank', 'noopener,noreferrer');
            });

            // Modales
            document.getElementById('empty-add-btn').addEventListener('click', openAddModal);
            document.getElementById('close-modal').addEventListener('click', closeAddModal);
            document.getElementById('cancel-btn').addEventListener('click', closeAddModal);
            document.getElementById('close-info-modal').addEventListener('click', closeInfoModal);

            // Formulario
            document.getElementById('business-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('add-gallery-btn').addEventListener('click', addGalleryInput);

            // Filtros
            document.getElementById('clear-filters').addEventListener('click', clearAllFilters);

            // Perfil de negocio
            document.getElementById('back-to-directory').addEventListener('click', closeBusinessProfile);

            // Botones de redes sociales
            document.getElementById('instagram-btn').addEventListener('click', () => openSocialMedia('instagram'));
            document.getElementById('whatsapp-btn').addEventListener('click', () => openSocialMedia('whatsapp'));
            document.getElementById('phone-btn').addEventListener('click', () => openSocialMedia('phone'));
            document.getElementById('location-btn').addEventListener('click', () => openSocialMedia('location'));

            // Panel de administrador
            document.getElementById('admin-btn-mobile').addEventListener('click', () => {
                closeMobileMenu();
                openAdminLogin();
            });
            document.getElementById('close-admin-login').addEventListener('click', closeAdminLogin);
            document.getElementById('cancel-admin-login').addEventListener('click', closeAdminLogin);
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            document.getElementById('back-to-main').addEventListener('click', closeAdminPanel);
            document.getElementById('logout-admin').addEventListener('click', closeAdminPanel);
            document.getElementById('admin-add-business').addEventListener('click', () => {
                closeAdminPanel();
                openAddModal();
            });
            document.getElementById('manage-categories').addEventListener('click', () => {
                showToast('ğŸ”§ FunciÃ³n de gestiÃ³n de categorÃ­as disponible prÃ³ximamente', 'info');
            });
            document.getElementById('manage-businesses').addEventListener('click', () => {
                showToast('ğŸ“Š FunciÃ³n de gestiÃ³n de negocios disponible prÃ³ximamente', 'info');
            });

            // Cerrar modales al hacer clic fuera
            setupModalCloseHandlers();
        }

        function setupModalCloseHandlers() {
            const modals = ['add-modal', 'info-modal', 'admin-login-modal'];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                        }
                    });
                }
            });
        }

        // Funciones de menÃº mÃ³vil
        function openMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const panel = document.getElementById('menu-panel');
            menu.classList.remove('hidden');
            setTimeout(() => {
                panel.style.transform = 'translateX(0)';
            }, 10);
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const panel = document.getElementById('menu-panel');
            panel.style.transform = 'translateX(100%)';
            setTimeout(() => {
                menu.classList.add('hidden');
            }, 300);
        }

        // FunciÃ³n scroll to top
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Funciones de bÃºsqueda y filtros
        function handleSearch() {
            activeFilters.search = document.getElementById('search-input').value.toLowerCase().trim();
            applyFilters();
            updateActiveFilters();
        }

        function filterByCategory(categoryName) {
            activeFilters.category = activeFilters.category === categoryName ? '' : categoryName;
            applyFilters();
            updateActiveFilters();
        }

        function applyFilters() {
            filteredBusinesses = allBusinesses.filter(business => {
                const matchesSearch = !activeFilters.search || 
                    business.nombre.toLowerCase().includes(activeFilters.search) ||
                    business.descripcion.toLowerCase().includes(activeFilters.search) ||
                    business.categoria.toLowerCase().includes(activeFilters.search);
                
                const matchesCategory = !activeFilters.category || business.categoria === activeFilters.category;
                
                return matchesSearch && matchesCategory;
            });

            renderBusinesses();
        }

        function updateActiveFilters() {
            const activeFiltersDiv = document.getElementById('active-filters');
            const filterTags = document.getElementById('filter-tags');
            
            const hasFilters = activeFilters.search || activeFilters.category;
            
            if (hasFilters) {
                activeFiltersDiv.classList.remove('hidden');
                let tags = [];
                
                if (activeFilters.search) {
                    tags.push(`<span class="px-2 py-1 rounded-full text-xs text-white" style="background-color: #151a2b;">ğŸ” "${activeFilters.search}"</span>`);
                }
                
                if (activeFilters.category) {
                    const category = categories.find(c => c.name === activeFilters.category);
                    tags.push(`<span class="px-2 py-1 rounded-full text-xs text-white" style="background-color: #db3717;">${category.icon} ${category.name}</span>`);
                }
                
                filterTags.innerHTML = tags.join('');
            } else {
                activeFiltersDiv.classList.add('hidden');
            }
        }

        function clearAllFilters() {
            activeFilters.search = '';
            activeFilters.category = '';
            document.getElementById('search-input').value = '';
            applyFilters();
            updateActiveFilters();
        }

        // Renderizar negocios
        function renderBusinesses() {
            const grid = document.getElementById('business-grid');
            const emptyState = document.getElementById('empty-state');
            const noResultsState = document.getElementById('no-results-state');

            if (allBusinesses.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                noResultsState.classList.add('hidden');
                return;
            }

            if (filteredBusinesses.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.add('hidden');
                noResultsState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            noResultsState.classList.add('hidden');

            grid.innerHTML = filteredBusinesses.map(business => {
                const category = categories.find(c => c.name === business.categoria);
                const businessId = business.id || business.__backendId || generateId();
                return `
                    <div class="business-card bg-white rounded-2xl shadow-md p-4 border-l-4" style="border-color: ${category ? category.color : '#db3717'};">
                        <div class="flex items-start space-x-3 mb-3">
                            <div class="w-16 h-16 bg-gray-100 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center text-gray-400 text-xs text-center flex-shrink-0 overflow-hidden">
                                ${business.logoUrl ? 
                                    `<img src="${escapeHtml(business.logoUrl)}" alt="Logo ${escapeHtml(business.nombre)}" class="w-full h-full object-cover rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                     <div class="w-full h-full flex items-center justify-center text-gray-400 text-xs" style="display: none;">ğŸ“·</div>` 
                                    : 'ğŸ“·'
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-bold truncate" style="color: #151a2b;">${escapeHtml(business.nombre)}</h3>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="text-lg">${category ? category.icon : 'ğŸ“‹'}</span>
                                    <span class="px-2 py-1 rounded-full text-xs text-white font-medium" style="background-color: ${category ? category.color : '#db3717'};">
                                        ${escapeHtml(business.categoria)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        ${business.descripcion ? `<p class="text-gray-600 text-sm mb-3 line-clamp-2">${escapeHtml(business.descripcion)}</p>` : ''}
                        
                        ${business.sitioWeb ? `
                            <div class="mb-3">
                                <a href="${escapeHtml(business.sitioWeb)}" target="_blank" rel="noopener noreferrer" 
                                   class="flex items-center space-x-2 text-sm hover:underline" style="color: #db3717;">
                                    <span class="text-lg">ğŸŒ</span>
                                    <span>Visitar sitio web</span>
                                </a>
                            </div>
                        ` : ''}
                        
                        <button onclick="viewBusinessProfile('${businessId}')" 
                                class="w-full py-3 px-4 rounded-xl font-medium text-white transition-all" 
                                style="background-color: #db3717;">
                            ğŸ‘ï¸ Ver Perfil Completo
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Funciones de modal
        function openAddModal() {
            const modal = document.getElementById('add-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('business-form').reset();
        }

        function closeAddModal() {
            const modal = document.getElementById('add-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showInfoModal(title, content) {
            document.getElementById('info-modal-title').textContent = title;
            document.getElementById('info-modal-content').innerHTML = content.replace(/â€¢/g, '<br>â€¢');
            const modal = document.getElementById('info-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeInfoModal() {
            const modal = document.getElementById('info-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Manejo de formulario
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (allBusinesses.length >= 999) {
                showToast('âŒ LÃ­mite mÃ¡ximo de 999 negocios alcanzado', 'error');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            submitBtn.disabled = true;

            // Recopilar URLs de galerÃ­a
            const galleryUrls = [];
            document.querySelectorAll('.gallery-url').forEach(input => {
                const url = input.value.trim();
                if (url) {
                    galleryUrls.push(url);
                }
            });

            const businessData = {
                id: generateId(),
                nombre: document.getElementById('business-name').value.trim(),
                categoria: document.getElementById('business-category').value,
                descripcion: document.getElementById('business-description').value.trim(),
                sitioWeb: document.getElementById('business-website').value.trim(),
                logoUrl: document.getElementById('business-logo').value.trim(),
                galleryImages: JSON.stringify(galleryUrls),
                telefono: '',
                fechaCreacion: new Date().toISOString()
            };

            try {
                if (window.isFirebaseConnected) {
                    // Usar Firebase
                    await saveBusinessToFirebase(businessData);
                    showToast('ğŸ”¥ Negocio publicado y sincronizado con Firebase', 'success');
                } else if (isDataSdkConnected && window.dataSdk) {
                    // Usar Data SDK de Canva
                    const result = await window.dataSdk.create(businessData);
                    if (result.isOk) {
                        showToast('ğŸ“Š Negocio publicado en Canva Sheet', 'success');
                    } else {
                        throw new Error(result.error);
                    }
                } else {
                    // Fallback a localStorage
                    allBusinesses.push(businessData);
                    saveBusinessesToStorage();
                    applyFilters();
                    updateBusinessCount();
                    showToast('ğŸ’¾ Negocio guardado localmente', 'success');
                }
            } catch (error) {
                console.error('Error guardando negocio:', error);
                showToast('âŒ Error al publicar negocio', 'error');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                closeAddModal();
            }
        }

        // Funciones auxiliares
        function updateBusinessCount() {
            const count = allBusinesses.length;
            const countElement = document.getElementById('business-count');
            if (count === 0) {
                countElement.textContent = 'No hay negocios publicados';
            } else if (count === 1) {
                countElement.textContent = '1 negocio publicado';
            } else {
                countElement.textContent = `${count} negocios publicados`;
            }
            
            // Actualizar estadÃ­sticas del admin
            document.getElementById('total-businesses').textContent = count;
        }

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Mostrar toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Ocultar y remover toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Funciones de perfil de negocio
        function viewBusinessProfile(businessId) {
            const business = allBusinesses.find(b => (b.id || b.__backendId) === businessId);
            if (!business) return;

            currentBusiness = business;
            
            document.getElementById('profile-business-name').textContent = business.nombre;
            
            // Actualizar logo del perfil
            const logoContainer = document.getElementById('profile-logo-container');
            if (business.logoUrl) {
                logoContainer.innerHTML = `
                    <img src="${escapeHtml(business.logoUrl)}" alt="Logo ${escapeHtml(business.nombre)}" 
                         class="w-full h-full object-cover rounded-xl" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-full h-full flex items-center justify-center text-gray-400 text-xs text-center" style="display: none;">
                        ğŸ“·<br>Logo<br>Empresa
                    </div>
                `;
            } else {
                logoContainer.innerHTML = 'ğŸ“·<br>Logo<br>Empresa';
            }
            
            const category = categories.find(c => c.name === business.categoria);
            const categoryElement = document.getElementById('profile-business-category');
            categoryElement.textContent = `${category ? category.icon : 'ğŸ“‹'} ${business.categoria}`;
            categoryElement.style.backgroundColor = category ? category.color : '#db3717';
            
            document.getElementById('profile-description').textContent = business.descripcion || 'Sin descripciÃ³n disponible.';
            
            // Mostrar pÃ¡gina de perfil
            document.getElementById('business-profile-page').classList.remove('hidden');
            
            // Iniciar galerÃ­a de imÃ¡genes
            startImageGallery();
        }

        function closeBusinessProfile() {
            document.getElementById('business-profile-page').classList.add('hidden');
            currentBusiness = null;
            stopImageGallery();
        }

        function openSocialMedia(platform) {
            if (!currentBusiness) return;
            
            switch (platform) {
                case 'instagram':
                    showToast('ğŸ“· FunciÃ³n de Instagram disponible prÃ³ximamente', 'info');
                    break;
                case 'whatsapp':
                    const message = encodeURIComponent(`Hola! Vi tu negocio "${currentBusiness.nombre}" en el directorio.`);
                    window.open(`https://wa.me/19752224?text=${message}`, '_blank', 'noopener,noreferrer');
                    break;
                case 'phone':
                    showToast('ğŸ“ FunciÃ³n de llamada disponible prÃ³ximamente', 'info');
                    break;
                case 'location':
                    showToast('ğŸ“ FunciÃ³n de ubicaciÃ³n disponible prÃ³ximamente', 'info');
                    break;
            }
        }

        function startImageGallery() {
            if (!currentBusiness) return;
            
            // Usar imÃ¡genes reales del negocio o imÃ¡genes por defecto
            let galleryImages = [];
            
            try {
                const parsedImages = JSON.parse(currentBusiness.galleryImages || '[]');
                if (parsedImages && parsedImages.length > 0) {
                    // Usar imÃ¡genes reales del negocio
                    galleryImages = parsedImages.map((url, index) => ({
                        type: 'image',
                        url: url,
                        text: `Imagen ${index + 1}`
                    }));
                }
            } catch (e) {
                // Si hay error parseando, usar imÃ¡genes por defecto
            }
            
            if (galleryImages.length === 0) {
                // Usar imÃ¡genes por defecto con emojis
                galleryImages = [
                    { type: 'emoji', emoji: 'ğŸª', text: 'Fachada del Local' },
                    { type: 'emoji', emoji: 'ğŸ›ï¸', text: 'Productos y Servicios' },
                    { type: 'emoji', emoji: 'ğŸ‘¥', text: 'Nuestro Equipo' },
                    { type: 'emoji', emoji: 'ğŸ¯', text: 'Ambiente Interior' },
                    { type: 'emoji', emoji: 'â­', text: 'Experiencia Cliente' }
                ];
            }
            
            currentSlide = 0;
            
            // Crear dots para la galerÃ­a
            const dotsContainer = document.getElementById('gallery-dots');
            dotsContainer.innerHTML = galleryImages.map((_, index) => 
                `<div class="w-2 h-2 rounded-full cursor-pointer transition-all ${index === 0 ? 'bg-orange-500' : 'bg-gray-300'}" 
                     onclick="goToSlide(${index})"></div>`
            ).join('');
            
            // FunciÃ³n para cambiar slide
            function updateSlide() {
                const slideElement = document.getElementById('gallery-slide');
                const currentImage = galleryImages[currentSlide];
                
                if (currentImage.type === 'image') {
                    slideElement.innerHTML = `
                        <img src="${escapeHtml(currentImage.url)}" alt="${escapeHtml(currentImage.text)}" 
                             class="w-full h-full object-cover rounded-xl"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full flex items-center justify-center text-gray-400 text-center" style="display: none;">
                            <div>
                                <div class="text-4xl mb-2">ğŸ–¼ï¸</div>
                                <p class="text-sm">Error al cargar imagen</p>
                            </div>
                        </div>
                    `;
                } else {
                    slideElement.innerHTML = `
                        <div class="text-center">
                            <div class="text-6xl mb-3">${currentImage.emoji}</div>
                            <p class="text-lg font-medium text-gray-600">${currentImage.text}</p>
                        </div>
                    `;
                }
                
                // Actualizar dots
                const dots = dotsContainer.children;
                for (let i = 0; i < dots.length; i++) {
                    dots[i].className = `w-2 h-2 rounded-full cursor-pointer transition-all ${
                        i === currentSlide ? 'bg-orange-500' : 'bg-gray-300'
                    }`;
                }
            }
            
            // FunciÃ³n global para cambiar slide manualmente
            window.goToSlide = function(index) {
                currentSlide = index;
                updateSlide();
            };
            
            updateSlide();
            
            // Auto-cambio cada 4 segundos
            galleryInterval = setInterval(() => {
                currentSlide = (currentSlide + 1) % galleryImages.length;
                updateSlide();
            }, 4000);
        }

        function stopImageGallery() {
            if (galleryInterval) {
                clearInterval(galleryInterval);
                galleryInterval = null;
            }
        }

        // Funciones de administrador
        function openAdminLogin() {
            const modal = document.getElementById('admin-login-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('admin-password').focus();
        }

        function closeAdminLogin() {
            const modal = document.getElementById('admin-login-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('admin-password').value = '';
        }

        function handleAdminLogin(e) {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            
            if (password === '1351') {
                isAdminLoggedIn = true;
                closeAdminLogin();
                openAdminPanel();
                showToast('âœ… Acceso concedido', 'success');
            } else {
                showToast('âŒ ContraseÃ±a incorrecta', 'error');
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-password').focus();
            }
        }

        function openAdminPanel() {
            document.getElementById('admin-page').classList.remove('hidden');
            updateAdminStats();
        }

        function closeAdminPanel() {
            document.getElementById('admin-page').classList.add('hidden');
            isAdminLoggedIn = false;
        }

        function updateAdminStats() {
            document.getElementById('total-businesses').textContent = allBusinesses.length;
            document.getElementById('total-categories').textContent = categories.length;
            
            // Negocios recientes (Ãºltimos 7 dÃ­as)
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const recentCount = allBusinesses.filter(business => 
                new Date(business.fechaCreacion) > weekAgo
            ).length;
            document.getElementById('recent-businesses').textContent = recentCount;
        }

        // Funciones para gestiÃ³n de galerÃ­a en el formulario
        function addGalleryInput() {
            const container = document.getElementById('gallery-inputs');
            const inputCount = container.children.length;
            
            if (inputCount >= 10) {
                showToast('âš ï¸ MÃ¡ximo 10 imÃ¡genes permitidas', 'info');
                return;
            }
            
            const newInput = document.createElement('div');
            newInput.className = 'flex items-center space-x-2';
            newInput.innerHTML = `
                <input type="url" class="gallery-url flex-1 px-4 py-3 border-2 rounded-xl focus:outline-none focus:ring-2"
                       style="border-color: #db3717; --tw-ring-color: #db3717;"
                       placeholder="https://ejemplo.com/imagen${inputCount + 1}.jpg">
                <button type="button" onclick="removeGalleryInput(this)" class="px-3 py-3 rounded-xl text-white" style="background-color: #ef4444;">
                    ğŸ—‘ï¸
                </button>
            `;
            
            container.appendChild(newInput);
        }

        function removeGalleryInput(button) {
            const container = document.getElementById('gallery-inputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                showToast('âš ï¸ Debe mantener al menos un campo de imagen', 'info');
            }
        }

        // Hacer funciones globales
        window.viewBusinessProfile = viewBusinessProfile;
        window.closeMobileMenu = closeMobileMenu;
        window.filterByCategory = filterByCategory;
        window.addGalleryInput = addGalleryInput;
        window.removeGalleryInput = removeGalleryInput;

        // Limpiar al cerrar
        window.addEventListener('beforeunload', () => {
            if (firebaseUnsubscribe) {
                firebaseUnsubscribe();
            }
        });

        // Inicializar aplicaciÃ³n
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992b897fb0e8e855',t:'MTc2MTE2Mjc2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
